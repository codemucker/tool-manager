#!/usr/bin/env tm-env-bash
#
# Save the backup to a git repo
#

set -Eeuo pipefail

config_dir="$TM_PLUGINS_CFG_DIR"
if [[ -d "$config_dir" ]]; then
    _warn "Existing config dir '$config_dir' already exists"
fi

if [[ ! -f "$config_dir/.gitignore" ]]; then
    echo "$(basename "$config_dir" )/" > "$config_dir/.gitignore"
fi
if [ "$(ls -A "$config_dir")" ]; then
    _warn "'$config_dir' already contains files, updating repo"
    _pushd "$config_dir"
    git pull --ff-only
else
    backup_repo="$(tm-cfg-get --tm TM_CFG_BACKUP_REPO)"
    if [[ -z "$backup_repo" ]]; then
        _fail "backup repo is not set"
    fi
    rmdir "$config_dir"
    git clone"$backup_repo"
fi
