#!/usr/bin/env tm-env-bash
#
# Save the backup to a git repo
#

set -Eeuo pipefail
source "$TM_BIN/.tm.boot.sh"

config_dir="$TM_PLUGINS_CFG_DIR"
if [[ ! -d "$config_dir" ]]; then
    _fail "Config dir '$config_dir' does not exist, no config to save"
fi

_pushd "$config_dir"
if [[ ! -f "$config_dir/../.gitignore" ]]; then
    echo "$(basename "$config_dir" )/" > "$config_dir/../.gitignore"
fi
if [[ ! -d ".git" ]]; then
    backup_repo="$(tm-cfg-get --tm TM_CFG_BACKUP_REPO)"
    if [[ -z "$backup_repo" ]]; then
        _fail "backup repo is not set"
    fi
    git init --bare
    git remote add origin "$backup_repo"
fi
git add .
git commit -m "Save config"
git push
