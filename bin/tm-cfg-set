#!/usr/bin/env tm-env-bash
#
# Set a configuration option for the core Tool Manager.
# Usage: tm-cfg-set <config_key> [value]
# If 'value' is not provided and the shell is interactive, prompts for the value.
#

_tm::source::include .tm.script.sh
_tm::source::include .tm.cfg.sh

declare -A args
# Using --opts-* to capture the command and its arguments after '--'
_parse_args \
    --file "${BASH_SOURCE[0]}" \
    --opt-this "|flag|group=plugin|desc=When set, auto detect plugin name" \
    --opt-tm "|flag|short=t|long=tm|group=plugin|desc=When set, use tool manager cfg" \
    --opt-plugin "|group=plugin|long=plugin|short=p|desc=The plugin to set the config for" \
    --opt-key "|short=k|required|long=key|desc=The key to set" \
    --opt-value "|remainder|long=value|short=v|desc=The value to set|required|" \
    --result args \
    -- "$@"

plugin_name="${args[plugin]}"
declare -A plugin=()
if [[ -n "$plugin_name" ]]; then
  _tm::util::parse::plugin_name plugin "$plugin_name"
elif [[ "${args[tm]}" ]]; then
    _tm::util::parse::plugin_id plugin "$__TM_PLUGIN_ID"
elif [[ "${args[this]}" ]]; then
    if [[ -z "${TM_PLUGIN_ID:-}" ]]; then
        _fail "Set flag '--this', but no env variable 'TM_PLUGIN_ID' has been set. Ensure you are calling this via the wrapper scripts"
    fi
    _tm::util::parse::plugin_id plugin "$TM_PLUGIN_ID"
else
    _tm::util::parse::plugin_id plugin "$__TM_PLUGIN_ID"
fi
value="${args['*']}"

_tm::cfg::set_value "${plugin[qname]}" "${args[key]}" "${args[value]}"
